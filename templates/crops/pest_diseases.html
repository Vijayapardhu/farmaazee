{% extends 'base.html' %}
{% load static %}

{% block title %}Pests & Diseases - Farmazee{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'crops:list' %}">Crops</a></li>
                    <li class="breadcrumb-item active">Pests & Diseases</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h3 mb-0">
                    <i class="fas fa-bug text-danger me-2"></i>
                    Crop Pests & Diseases
                </h2>
                <div>
                    <a href="{% url 'crops:list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Crops
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   placeholder="Search by name, description, symptoms..." 
                                   value="{{ search_query }}">
                        </div>
                        <div class="col-md-3">
                            <label for="type" class="form-label">Type</label>
                            <select class="form-select" id="type" name="type">
                                <option value="">All Types</option>
                                {% for choice in type_choices %}
                                <option value="{{ choice.0 }}" {% if selected_type == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="severity" class="form-label">Severity</label>
                            <select class="form-select" id="severity" name="severity">
                                <option value="">All Severities</option>
                                {% for choice in severity_choices %}
                                <option value="{{ choice.0 }}" {% if selected_severity == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="row">
        <div class="col-12">
            {% if pest_diseases %}
                <div class="row">
                    {% for pest_disease in pest_diseases %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 border-left border-{% if pest_disease.type == 'pest' %}warning{% else %}danger{% endif %}">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-{% if pest_disease.type == 'pest' %}bug{% else %}virus{% endif %} me-2"></i>
                                        {{ pest_disease.name }}
                                    </h5>
                                    <div>
                                        <span class="badge bg-{% if pest_disease.type == 'pest' %}warning{% else %}danger{% endif %} me-2">
                                            {{ pest_disease.get_type_display }}
                                        </span>
                                        <span class="badge bg-{% if pest_disease.severity == 'high' %}danger{% elif pest_disease.severity == 'medium' %}warning{% else %}success{% endif %}">
                                            {{ pest_disease.get_severity_display }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6 class="text-muted">Description</h6>
                                    <p class="card-text">{{ pest_disease.description }}</p>
                                </div>
                                
                                {% if pest_disease.symptoms %}
                                <div class="mb-3">
                                    <h6 class="text-muted">Symptoms</h6>
                                    <p class="card-text">{{ pest_disease.symptoms }}</p>
                                </div>
                                {% endif %}
                                
                                <div class="mb-3">
                                    <h6 class="text-muted">Treatment Methods</h6>
                                    <p class="card-text">{{ pest_disease.treatment_methods }}</p>
                                </div>
                                
                                <div class="mb-3">
                                    <h6 class="text-muted">Prevention Methods</h6>
                                    <p class="card-text">{{ pest_disease.prevention_methods }}</p>
                                </div>
                                
                                {% if pest_disease.affected_crops.all %}
                                <div class="mb-3">
                                    <h6 class="text-muted">Affected Crops</h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for crop in pest_disease.affected_crops.all %}
                                        <span class="badge bg-light text-dark">{{ crop.name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        Added on {{ pest_disease.created_at|date:"M d, Y" }}
                                    </small>
                                    {% if user.is_authenticated %}
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="reportPestDisease('{{ pest_disease.id }}', '{{ pest_disease.name }}')">
                                        <i class="fas fa-flag me-1"></i>Report
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if pest_diseases.has_other_pages %}
                <nav aria-label="Pest and disease pagination">
                    <ul class="pagination justify-content-center">
                        {% if pest_diseases.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pest_diseases.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_severity %}&severity={{ selected_severity }}{% endif %}">
                                Previous
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in pest_diseases.paginator.page_range %}
                        {% if pest_diseases.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > pest_diseases.number|add:'-3' and num < pest_diseases.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_severity %}&severity={{ selected_severity }}{% endif %}">
                                {{ num }}
                            </a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if pest_diseases.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pest_diseases.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if selected_severity %}&severity={{ selected_severity }}{% endif %}">
                                Next
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No pests or diseases found</h4>
                    <p class="text-muted">
                        {% if search_query or selected_type or selected_severity %}
                            Try adjusting your search criteria or filters.
                        {% else %}
                            No pests or diseases have been added yet.
                        {% endif %}
                    </p>
                    {% if search_query or selected_type or selected_severity %}
                    <a href="{% url 'crops:pest_diseases' %}" class="btn btn-outline-primary">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Prevention Tips -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt text-success me-2"></i>
                        General Prevention Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-seedling text-success fa-2x me-3"></i>
                                </div>
                                <div>
                                    <h6>Use Resistant Varieties</h6>
                                    <p class="text-muted small">Choose crop varieties that are naturally resistant to common pests and diseases in your area.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-rotate text-primary fa-2x me-3"></i>
                                </div>
                                <div>
                                    <h6>Crop Rotation</h6>
                                    <p class="text-muted small">Practice crop rotation to break pest and disease cycles and maintain soil health.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-leaf text-success fa-2x me-3"></i>
                                </div>
                                <div>
                                    <h6>Proper Spacing</h6>
                                    <p class="text-muted small">Maintain adequate spacing between plants to improve air circulation and reduce disease spread.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-tint text-info fa-2x me-3"></i>
                                </div>
                                <div>
                                    <h6>Water Management</h6>
                                    <p class="text-muted small">Avoid overhead watering and water early in the day to allow leaves to dry quickly.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left {
    border-left: 4px solid !important;
}

.border-warning {
    border-left-color: #ffc107 !important;
}

.border-danger {
    border-left-color: #dc3545 !important;
}

.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
}
</style>

<script>
function reportPestDisease(pestDiseaseId, pestDiseaseName) {
    // This function can be expanded to open a reporting modal or redirect to a reporting page
    alert(`Reporting ${pestDiseaseName} (ID: ${pestDiseaseId}). This feature will be implemented soon.`);
}
</script>
{% endblock %}
